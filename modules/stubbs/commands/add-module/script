#!/usr/bin/env bash

#/ command: stubbs:add-module: "add a new module"
#/ usage: rerun stubbs:add-module  --description <>  --module|-m <> [ --template <>] [ --help|-?] 
#/ rerun-variables: RERUN, RERUN_VERSION, RERUN_MODULES, RERUN_MODULE_DIR
#/ option-variables: DESCRIPTION MODULE TEMPLATE HELP

. $RERUN_MODULE_DIR/lib/functions.sh add-module || { 
  echo >&2 "Failed loading function library." ; exit 1 ; 
}

set -o errexit -o nounset -o pipefail

rerun_options_parse "$@"

# Command implementation
# ----------------------

# - - -

STUB=$RERUN_MODULE_DIR/lib/stub/bash
if [[ -n "${TEMPLATE:-}" ]]
then
	[[ ${TEMPLATE} == "pedantic" ]] && STUB=$RERUN_MODULE_DIR/lib/stub/bash-pedantic
fi

[[ ! -d "$STUB" ]] && rerun_die "module stub not found: $STUB"

TEMPLATE_FUNCTION_LIB=$(rerun_property_get $STUB TEMPLATE_FUNCTION_LIB)

COMMAND_SHELL=$(rerun_property_get $STUB COMMAND_SHELL)

[[ ! -f  $STUB/$TEMPLATE_FUNCTION_LIB ]] && {
    rerun_die "function library not found:  $STUB/$TEMPLATE_FUNCTION_LIB"
}

# Create module structure

RERUN_MODULE_HOME_DIR=$(echo "$RERUN_MODULES" | cut -d: -f1)/$MODULE

mkdir -p $RERUN_MODULE_HOME_DIR || rerun_die "Failed creating module structure."
# Create commands/ subdirectory
mkdir -p $RERUN_MODULE_HOME_DIR/commands || rerun_die "Failed creating module structure."
# Create lib/ subdirectory
mkdir -p $RERUN_MODULE_HOME_DIR/lib || rerun_die "Failed creating module structure."

# Generate a profile for metadata
(
cat <<EOF
# generated by stubbs:add-module
# $(date)
NAME=$MODULE
DESCRIPTION="$DESCRIPTION"
SHELL="${COMMAND_SHELL}"
VERSION=1.0.0
REQUIRES=
EXTERNALS=
LICENSE=
EOF
) > $RERUN_MODULE_HOME_DIR/metadata || rerun_die "Failed generating metadata."

# Give it the beginnings of a function library.
# Replace the word "@MODULE@" with the module's given name.
sed -e "s/@MODULE@/$MODULE/g" \
	-e "s^@DESCRIPTION@^$DESCRIPTION^g" \
	-e "s,@SHELL@,$COMMAND_SHELL,g" \
    "$STUB/$TEMPLATE_FUNCTION_LIB" \
    > "$RERUN_MODULE_HOME_DIR/lib/$(basename $TEMPLATE_FUNCTION_LIB)" || {
    rerun_die "Failed creating function library for \"$MODULE\"."
}

# If --template was specified, resolve its directory path
# and clone its contents into the new module.
if [[ -n "${TEMPLATE:-}" ]]
then
    if [[ "$TEMPLATE" =~ [/]+ ]]
    then TEMPLATE_DIR=$(rerun_path_absolute $TEMPLATE)
    else TEMPLATE_DIR=$(rerun_module_exists $TEMPLATE)
    fi
    rerun_log info "Copying files from template: $TEMPLATE..."
    stubbs_module_clone $RERUN_MODULE_HOME_DIR $TEMPLATE_DIR
fi

rerun_log info "Created module structure: $RERUN_MODULE_HOME_DIR."

# - - -

# Done. Exit with last command exit status.
exit $?
